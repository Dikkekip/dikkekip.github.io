## How to Secure Admin Access - Part 2: Automating Persona-Based Conditional Access Policies ğŸ›¡ï¸âœ¨

Welcome back, fellow IT wizards ğŸ§™â€â™‚ï¸ğŸ§™â€â™€ï¸, to our magical journey of securing admin access! This time, we're diving into **Persona-Based Conditional Access Policies**, which are essentially enchanted wards ğŸ§™â€â™‚ï¸ğŸ”® tailored to different roles. Instead of casting a generic **Protego Totalum** ğŸ›¡ï¸ over everyone, we're going to fine-tune our spells (ahem, policies) based on role, access requirements, and risk levels. 

For example, your mighty Global Administrator (think **Dumbledore of Entra ID**) needs stricter security enchantments than an average user just accessing coffee orders â˜•ğŸ“‹.

### Why Persona-Based Policies Matter âš–ï¸

Not everyone in your organization needs the power of a **Nimbus 2000** ğŸ†. Some users, like HR employees handling sensitive data ğŸ—‚ï¸, need extra protection, but it's nothing compared to what your **Global Administrators** need. That's where persona-based policies come in. Like casting a **Lumos** ğŸ’¡ thatâ€™s bright enough to guide you but doesnâ€™t blind anyone, these policies balance security and usability. ğŸŒ

With these, you can require extra steps (think of MFA as a **magic incantation ğŸ§©**) for high-risk users, while others breeze through securely. ğŸ”

### Persona Breakdown ğŸ§™â€â™‚ï¸ğŸ“œ

In this realm of Conditional Access, users fit into different personas, each getting a specific set of security spells tailored to their role:

- **ca-persona-admins**: High-privilege admins, needing **phishing-resistant MFA** ğŸ›¡ï¸ (you donâ€™t want your castle walls breached by a simple charm ğŸ§™â€â™‚ï¸).
- **ca-persona-global**: Global protection ğŸ°â€”applied universally to everyone. This is your foundation spell!
- **ca-persona-externals**: External contractors ğŸ§³ get limited access, bounded by specific application policies ğŸ”.
- **ca-persona-guests**: Guests ğŸ“ (visiting from another realm) have light security, with restricted access to resources.
- **ca-persona-internals**: Regular employees ğŸ§‘â€ğŸ’¼ who need moderate protection (MFA) while accessing their day-to-day applications.
- **ca-persona-guestadmins**: Guests granted temporary **admin powers ğŸ†** (think students borrowing a professor's wand), requiring **Protego Maxima** ğŸ›¡ï¸ğŸ›¡ï¸.
- **ca-persona-developers**: Developers ğŸ§‘â€ğŸ’» playing with sensitive environments ğŸ”®, needing strict device compliance and MFA.
- **ca-persona-serviceaccounts**: Service accounts ğŸ¤–, often automated, require special protections like **managed identities** and token policies. (You donâ€™t want these going rogue, like a Niffler chasing shiny tokens âœ¨ğŸ¦¡.)

### The Magical Framework from Claus Jespersen ğŸ§™â€â™‚ï¸ğŸ’»

Claus Jespersen and his brilliant team have provided an excellent guide for implementing these persona-based policies. They crafted the **Conditional Access Framework**, built on **Zero Trust principles**, and itâ€™s an absolute game-changer ğŸ”. This framework uses a clear naming convention for different personas, helping you manage policies and avoid potential conflicts. 

Claus's work includes an invaluable **[Excel Workbook](https://github.com/microsoft/ConditionalAccessforZeroTrustResources/raw/main/ConditionalAccessSamplePolicies/Microsoft%20Conditional%20Access%20for%20Zero%20trust%20persona%20based%20policies.xlsx)**, which provides a template for persona-based Conditional Access policies. Alongside this, the **[PDF guide](https://github.com/microsoft/ConditionalAccessforZeroTrustResources/blob/main/ConditionalAccessGovernanceAndPrinciplesforZeroTrust%20October%202023.pdf)** explains the governance and principles in great detail.

**Huge kudos to Claus** for making it easy to implement this in the real world! ğŸ‰ğŸ”®

### Automating Persona Creation with PowerShell ğŸª„ğŸ’»

Managing security spells (oops, I mean policies) can be time-consuming. Hereâ€™s where a bit of automation magic via PowerShell âš¡ğŸ’» can save the day. Below is a spell (aka script ğŸ§‘â€ğŸ’») that automates the creation of security groups for your personas.

#### PowerShell Script for Creating Security Groups âš™ï¸
scripts\2024-07-29-SecuringAdminAccess\Create-groups.ps1
Group Creation Script: [Create-groups.ps1](https://raw.githubusercontent.com/Dikkekip/dikkekip.github.io/main/scripts/2024-07-29-SecuringAdminAccess/Create-groups.ps1)

![Screenshot](assets/img/SecuringAdminAccess/Screenshot%202024-09-21%20142118.png)


This PowerShell script helps you create persona-based security groups for **admins**, **service accounts**, and **guests** from distant lands ğŸŒ. Customize group types and membership rules to fit your unique wizarding (or organizational) needs ğŸ°âœ¨.
Sure! Here's a wizarding-style update for the **Creating Admin and Break Glass Accounts** section:

### Creating Admin and Break Glass Accounts ğŸ§™â€â™‚ï¸ğŸ”

Admins are like the **Masters of the Elder Wand** ğŸª„ in your organizationâ€”so they need extra layers of protection. Similarly, Break Glass accounts are your **emergency exit spells** ğŸ§©, only used in dire situations when admin accounts might fail. The PowerShell script below ensures both types of accounts are secured with the proper magical safeguards ğŸ›¡ï¸.

The script automates the creation of Admin accounts and Break Glass accounts, setting them up with strong passwords (no Alohomora here!) and assigning them appropriate roles and permissions, including **Global Administrator role eligibility** through Privileged Identity Management (PIM).

#### Admin Users Creation Script âš™ï¸
For full details and to get the script, you can download it here: [Create-Users.ps1](https://raw.githubusercontent.com/Dikkekip/dikkekip.github.io/main/scripts/2024-07-29-SecuringAdminAccess/Create-Users.ps1)

![Screenshot](assets/img/SecuringAdminAccess/Create-Users.png)

#### Key Features of the Script:

- **Complex Password Generation**: No basic "Expelliarmus" spells here. The script conjures complex passwords ğŸ” using a mix of uppercase, lowercase, numbers, and special characters.
- **Admin Account Creation**: Adds new admins, checks for existing accounts, and assigns them to the appropriate Conditional Access groups like **ca-persona-admins** ğŸ›¡ï¸.
- **Break Glass Accounts**: Creates or verifies up to two Break Glass accounts (BG1 and BG2), with secure passwords and limited access, acting as your last-resort safety net. Think of it as your magical emergency plan ğŸ’¼ğŸ›‘.
- **Global Admin Eligibility**: Automatically assigns **Global Administrator** role eligibility via PIMâ€”because we want our admins to wield their power responsibly ğŸ†.


#### The **Break Glass** Effect ğŸ’¼ğŸ›¡ï¸

- If your main admin accounts are locked out, Break Glass accounts are your fallback. This script ensures their **Global Admin** role is always accessible, even when regular systems falter. Theyâ€™re like magical safeguards with minimal everyday usage, but theyâ€™ll save you when things get chaotic! ğŸ›¡ï¸âœ¨

#### **Admin Accounts** ğŸ°ğŸ”


### Automating Conditional Access Policies (No Marauderâ€™s Map Needed) ğŸ—ºï¸

Now that your security groups are conjured and the Admin and Break Glass accounts are safely created, itâ€™s time to automate those Conditional Access policies ğŸ¯. But alas, we face some challenges! While we want admins to use **Phishing Resistant Tokens** (our most powerful protection spells ğŸª„), we also need a way for them to register their **FIDO2 keys** (because Passkeys are no ordinary charms ğŸ”‘).

The first hurdle: our **MFA campaign** doesnâ€™t support asking for Passkeys/FIDO keys right away. So, we need a workaround to let admins use MFA or **Tap to Sign In** temporarily while they register their FIDO2 keys.

#### How to Solve This Conundrum ğŸ§©

Instead of excluding these admins from our **Phishing Resistant** policy forever (thatâ€™s like leaving Hogwarts unprotected ğŸ°), weâ€™ll create an **alternative authentication strength** for initial MFA. This allows first-time use with a manageable authentication method, and then users can register their FIDO2 keys or Passkeys via the authenticator app. Learn more about this in **Microsoft's guide on [Authentication Strength](https://learn.microsoft.com/en-gb/entra/identity/authentication/concept-authentication-strengths)**.
![Screenshot](assets/img/SecuringAdminAccess/authenticationStrengths.png)

<!-- markdownlint-capture -->
<!-- markdownlint-disable -->
#### Pro Tip:
> **âš ï¸ Always keep a break-glass account handy!** Configuring Conditional Access with code can be dangerous. Thankfully, this script creates policies without enabling them immediately. Consider it your safety net (or **Protego charm** ğŸ›¡ï¸) before you apply the real protection! ğŸ™ƒ
{: .prompt-warning }
<!-- markdownlint-restore -->
---

### Conditional Access Policies Overview ğŸ”

Once your security groups are in place and the admins and Break Glass accounts are created, itâ€™s time to automate the Conditional Access policies ğŸ¯. These policies form a **Conditional Access framework** to manage security across different personas (e.g., **Admins**, **Internals**, **Externals**, etc.).

The challenge arises because we want all admins to use **Phishing Resistant Tokens**, but they still need a way to register their FIDO2 keys. Since the current **MFA registration campaigns** donâ€™t allow asking for FIDO keys upfront, we need a temporary workaround. Hereâ€™s how weâ€™ll tackle this conundrum:

1. **Create an alternative authentication strength** that allows admins to use **MFA** or **Tap to Sign In** for first-time use.
2. **Exclude** these admins temporarily from the Phishing Resistant policy.
3. **Allow them to register their FIDO2 key** or **Passkey** in the authenticator app.

Once this initial setup is complete, the policy can be re-applied to enforce phishing-resistant tokens without permanent exclusions.

### Key Conditional Access Policies for Admin Protection ğŸ›¡ï¸

By leveraging **phishing-resistant** authentication (like FIDO2), **MFA**, and **session policies**, you establish secure, targeted access control for various apps and platforms. Some of the key policy types youâ€™ll want to automate include:

- **Base Protection**: A general layer of security for all personas.
- **Identity Protection**: Risk-based sign-ins protection.
- **Data and App Protection**: Enforce security on mobile platforms.
- **Attack Surface Reduction**: Prevent risky or unknown devices and platforms from accessing resources.

This structured approach ensures robust security across multiple layers, allowing your admins to work securely while gradually shifting them to the most secure authentication methods.

### Automating Conditional Access Policies with PowerShell ğŸ§™â€â™‚ï¸ğŸ”®
This spell automatically creates and applies the right Conditional Access policies based on each persona ğŸ¯. By automating the process, your admins, employees, and guests can safely navigate your secure environment without manually casting every protection spell. ğŸ›¡ï¸ğŸ”’
#### Conditional Access Creation Script âš™ï¸
For full details and to get the script, you can download it here: [Create-Users.ps1](https://raw.githubusercontent.com/Dikkekip/dikkekip.github.io/main/scripts/2024-07-29-SecuringAdminAccess/Create-CAPolicies.ps1)
![Screenshot](assets/img/SecuringAdminAccess/Create-Ca.png)


### Conclusion: Mastering the Security Spellbook ğŸ“œâœ¨

By leveraging **persona-based Conditional Access policies**, you ensure both a secure and user-friendly experience for your organization. And thanks to Claus Jespersen's framework ğŸ§™â€â™‚ï¸ğŸ”®, implementing these strategies has never been easier. Automating policies and groups with PowerShell ensures your defenses are consistently strong ğŸ›¡ï¸, scaling effortlessly as your organization grows.

Stay tuned for more chapters in this security spellbook, where weâ€™ll continue to dive into the magic of security automation. Until then, may your spells be strong, your MFA tokens unbreakable, and your admins wise! ğŸ”®âœ¨

**Accio Security!** ğŸ§™â€â™€ï¸âš¡
